# 文件IO

- 文件基本操作，打开、定位、读写、关闭
  - fopen和open，C库fopen有功能扩展

- IO效率

- 文件共享(必考)

- 其他重要IO函数

## 文件操作基本顺序

- 打开 open

- 创建 creat

- 定位 lseek

- 读 read

- 写 write

- 关闭 close

### open函数

用于打开或者创建一个文件

函数原型

```c
#include<fcntl.h>
int open(const char* pathname, int oflag, ...)
    //打开或创建的文件名，用于指定文件打开模式、标志等信息
    //需要前赋予文件权限，Linux的9个权限
```

#### oflag

- Linux头文件已经为文件打开模式、标志等定义了若干的宏

- oflag需要指定这些宏

- 宏定义在/usr/include/bits/fcntl.h中

- 在该头文件中，只读打开标志被定义为

- #define O_RDONLY  00

- 文件打开模式标志

  ​	以下三个标志必须指定一个且只能指定一个

  - O_RDONLY ： 只读打开

  - O_WRONLY ： 只写打开

  - O_RDWR   ： 读写打开

- 其他文件标志

   下面的标志是可以选择的，可通过C语言的或运算与文件打开标志进行组合

  - O_APPEND：每次写的数据都添加到文件尾

  - O_TRUNC：若此文件存在，并以(权限)读写或只写打开，则文件长度为0

  - O_CREAT：若文件不存在，则创建该文件。此时，open函数需要第三个参数，用于指定该文件的访问权限位

  - O_EXCL：若同时指定了O_CREAT标志，而文件已经存在，则会出错。可用于测试文件是否存在

返回值

- 整数数据
  - 成功时，返回文件描述符
  - 出错时，返回-1

文件描述符

- Window时返回文件句柄，是同一个描述
- 文件描述符：已打开文件的索引-->通过通过索引找到已打开文件

### 进程打开文件的内核数据结构

![进程打开文件](img\进程打开文件.png)

子进程会复制父进程fd_arrag数组，缺省时0、1、2被打开。默认打开，标准输入/输出/出错

task-struct的files可以但不一定共用，不一定每一个进程有files_struct甚至会共享

从fd数组里面找到一个没有表项的数组项

读取文件描述符，找到PCB，取出已打开文件表files，读出file结构体

找到dentry（目录项）找到inode(索引节点)

file里面的flag是两个字段，存放open时的标志

进程创建时，创建了task_strct和files_struct的链接

