# 嵌入式软件系统

## 嵌入式软件系统概述

这一部分可以参考[软件工程概述部分](..\软件工程\软件工程简介.md)

一种逻辑实体，具有抽象性

软件没有明显制作过程

使用过程中，没有磨损、老化的问题

对环境有不同程度的依赖性，导致了软件移植问题

### 特点

- 规模小，开发难度大
  - 软件包括板级初始化程序（BSP）、驱动程序、嵌入式操作系统、应用程序、测试程序
- 快速启动，直接运行
- 实时性和可靠性要求高
- 程序一体化
  - 应用程序和操作系统，一体化程序
- 两个平台
  - 开发平台，运行平台

## 嵌入式软件系统的分类

系统软件：控制、管理计算机系统的资源

支持软件：辅助软件开发的工具，（国标将中间件划分在这里，与教材不同）

应用软件：面向应用领域

从运行平台来分

- 运行在开发平台上的软件
- 运行在嵌入式系统上的软件：SOC，应用程序、驱动程序及部分开发工具

## 嵌入式软件系统的体系结构

应用层

中间件层

​	CORBA，JAVA，DCOM，面向应用领域的中间件

操作系统层

驱动层

- 板级初始化程序

  微处理器、存储器、中断控制器、DMA、定时器的初始化

- 与系统软件相关的驱动

  一般与系统绑定

- 与应用软件相关的驱动

硬件

## 运行流程

板级初始化

- 上电复位
  - CPU中堆栈指针寄存器的初始化
  - BSS段

系统引导/升级阶段

​	引导方式

- NOR Flash读取加载到RAM中

- 不需要引导到RAM直接在NorFlash，进入系统初始化

- 软件从外存中读取出来加载到RAM中运行

  升级阶段

- 远程升级，本地升级

应用初始化

​	应用任务的创建，信号量、消息队列的创建

多任务应用运行阶段

# 嵌入式操作系统的演变

## 概述

嵌入式操作系统是应用在嵌入式系统的操作系统，具有一般操作系统的功能，同时具有嵌入式软件的特点

- 可固化
- 可配置、可裁剪
- 独立的板级支持包，可修改
- 不同的CPU有不同的版本
- 应用的开发需要有集成交叉开发工具

无操作系统：基于单片机

简单操作系统：简单内核

实时操作系统：嵌入式实时多任务操作系统RTOS，具备多任务内核外，包括嵌入式文件、设备管理、嵌入式TCP/IP、嵌入式GUI等

RTOS举例

​	VRTX，VxWorks，QNX，TinyOS，μcOS-II，TRLinux，eCos，Android，IOS

## 分类

从应用领域来分

- SymbianOS、MS MobileOS，PalmOS、Embedded Linux，OSEK/AUTOSAR

从实时性的角度来分

- VxWorks、QNX、Nuclear、OSE、DeltaOS（国产嵌入式OS）、ITRON OS
- WinCE，众多嵌入式Linux，PalmOS

商业模式

- 商业型：功能稳定...、开发费用+版税
- 开源型

## 体系结构

目前操作系统的体系结构

### 宏内核（单块结构）

- 操作系统由多种模块构成
- 模块之间可相互调用
- 用户态和核心态两种工作模式
- 两种执行权限和执行空间

如：Android

![宏内核结构](img\宏内核结构.png)

- 层次结构
  - 上层不能修改下层的数据
  - N-1层为N层提供服务
  - 提高操作系统的安全性

  用户模式：用户

  内核模式：文件系统，进程通信，IO和设备管理，虚存管理，基本进程管理

  硬件

### 客户/服务器（微内核）结构

- **微内核**，只完成任务管理、任务调度、通信等基本功能

- 其它功能实现为**系统任务或进程**，运行于用户模式

- 用户任务通过**系统调用发出请求**，服务器响应请求，微内核负责完成通信、同步、任务调度等基本功能

![客户服务器结构（微内核结构）](img\客户服务器结构.png)

微内核结构的优点

- 提供一致的接口

- 可扩展性：扩展对新的软件/硬件支持

- 灵活性：可伸缩

- 可移植性

- 分布式系统支持

- 适用于面向对象操作系统环境

性能问题

- 通过微内核构造和发送信息、接受应答并解码所花费的时间比进行一次系统调用的时间多

- 很大程度取决于微内核的大小和功能

![QNX4.25的体系结构](img\QNX4.25的体系结构.png)

### 分层和模块化

目前嵌入式操作系统主要采用分层和模块化相结合的结构或微内核结构。

- **分层和模块化结合**的结构将操作系统分为**硬件无关层、硬件抽象层和硬件相关层**，每层再划分功能模块。

- 这样移植工作便集中在硬件相关层，与其余两层无关，功能的伸缩则集中在模块上，从而确保其具有良好的可移植性和可伸缩性。

- 而采用微内核结构，则可利用其可伸缩的特点适应硬件的发展，便于扩展。 

![DeltaCORE的体系结构](img\DeltaCORE的体系结构.png)

![TinyOS](img\TinyOS.png)

## 嵌入式操作系统的组成

通用操作系统组成：进程管理，存储器管理，文件管理，设备管理，用户界面

### 嵌入式内核

- 内核是嵌入式操作系统的基础，也是必备的部分。

- 内核还提供特定的应用编程接口，但目前没有统一的标准。

任务管理

- 内核的核心部分，具有**任务调度、创建任务、删除任务、挂起任务、解挂任务、设置任务优先级**等功能。

  任务调度原则

- 通用计算机的操作系统追求的是最大的吞吐率，为了达到最佳整体性能，其调度原则是公平，采用Round-Robin或可变优先级调度算法，调度时机主要以时间片为主驱动。

- 而嵌入式操作系统多采用基于静态优先级的可抢占的调度，任务优先级是在运行前通过某种策略静态分配好的，一旦有优先级更高的任务就绪就马上进行调度。

内存管理

- 嵌入式操作系统的内存管理比较简单。

- 通常不采用**虚拟存储管理**，而采用**静态内存分配和动态内存分配**（固定大小内存分配和可变大小内存分配）相结合的管理方式。

- 有些内核利用**MMU机制**提供内存保护功能。

- 通用操作系统广泛使用了虚拟内存的技术，为用户提供一个功能强大的虚存管理机制。

通信、同步和互斥机制

- 这些机制提供任务间、任务与中断处理程序间的通信、同步和互斥功能。

- 一般包括信号量、消息、事件、管道、异步信号和共享内存等功能。

- 与通用操作系统不同的是，嵌入式操作系统需要解决在这些机制的使用中出现的优先级反转问题。

中断管理，一般具有以下功能：

- 安装中断服务程序

- 中断发生时，对中断现场进行保存，并且转到相应的服务程序上执行

- 中断退出前，对中断现场进行恢复

- 中断栈切换

- 中断退出时的任务调度 

时间管理

- 提供**高精度、应用可设置的系统时钟**，该时钟是嵌入式系统的时基，可设置为十毫秒以下。

- 提供**日历时间**，负责与时间相关的任务管理工作如任务对资源有限等待的计时、时间片轮转调度等，提供软定时器的管理功能等。

- 通用操作系统的系统时钟的精度由操作系统确定，应用不可调，且一般是几十个毫秒。

任务扩展功能

- 任务扩展功能就是在内核中设置一些**Hook的调用点**，在这些调用点上内核调用应用设置的、应用自己编写的扩展处理程序，以扩展内核的有关功能。

- Hook调用点有任务创建、任务切换、任务删除、出错处理等。

### 嵌入式TCP/IP

TCP/IP协议已经广泛地应用于嵌入式系统中

嵌入式TCP/IP网络系统提供符合TCP/IP协议标准的协议栈，提供Socket编程接口

嵌入式TCP/IP网络系统具有以下的特点：

- 可剪裁：

  能根据嵌入式系统的功能的要求选择所需的协议，对完整的TCP/IP协议簇进行剪裁，以满足用户的需要。

- 采用“零拷贝”（Zero Copy）技术，提高实时性

  所谓“零拷贝”技术，是指TCP/IP协议栈没有用于各层间数据传递的缓冲区，协议栈各层间传递的都是数据指针，只有当数据最终要被驱动程序发送出去或是被应用程序取走时，才进行真正的数据搬移。

- 采用静态分配技术

  在网络初始化时就静态分配通信缓冲区，设置了专门的发送和接收缓冲（其大小一般小于或等于物理网络上的MTU值），从而确保了每次发送或接收时处理的数据不会超过MTU值，也就避免了数据处理任务的阻塞等待。 

### 嵌入式文件系统

通用操作系统的文件系统通常具有以下功能：

- 提供用户对文件操作的命令

- 提供用户共享文件的机制

- 管理文件的存储介质

- 提供文件的存取控制机制，保障文件及文件系统的安全性

- 提供文件及文件系统的备份和恢复功能

- 提供对文件的加密和解密功能

嵌入式文件系统相比之下较为简单，主要具有文件的存储、检索、更新等功能，一般不提供保护和加密等安全机制。

它以**系统调用和命令方式**提供对文件的各种操作，主要有：

- 设置和修改对文件和目录的存取权限 

- 提供建立、修改、改变、删除目录等服务

- 提供创建、打开、读、写、关闭、撤消文件等服务 

## 嵌入式实时操作系统µC/OS-II简介

µC/OS-II是一个**抢占式实时多任务内核**。它是用ANSI的C语言编写的，包含一小部分汇编语言代码，使之可以提供给不同架构的微处理器使用。

至今，从8位到64位，µC/OS-II已经在40多种不同架构的微处理器上使用。

使用µC/OS的领域包括：照相机行业、航空业、医疗器械、网络设备、自动提款机以及工业机器人等。 

µC/OS-II全部以源代码的方式提供，大约有5500行。

CPU相关的部分使用的是针对Intel80x86微处理器的代码。

µC/OS-II可以很容易地移植到不同架构的嵌入式微处理器上。 

µC/OS-II的特点：源代码、可移植、可固化、可裁减、可抢占性、支持多任务、可确定性、任务栈、系统服务、中断管理、稳定性和可靠性

------

基本术语

任务 task：RTOS的一个程序运行实体，调度的基本单位（教程约定任务和线程等价）

上下文切换

抢占(Preemptive)调度：

不可抢占(Non-Preemptive)调度：

互斥（Mutual Exclusion）

优先级驱动（priority Driven）

可调度性（Schedulability)：一个任务完成时间不大于截止时间

优先级反正，优先级调度